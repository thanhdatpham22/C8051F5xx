C51 COMPILER V9.54   MAIN                                                                  04/22/2025 16:36:42 PAGE 1   


C51 COMPILER V9.54, COMPILATION OF MODULE MAIN
OBJECT MODULE PLACED IN main.OBJ
COMPILER INVOKED BY: C:\Keil_v5\C51\BIN\C51.exe main.c DB OE BR INCDIR(c:\SiLabs\MCU_4\Inc)

line level    source

   1          
   2          //-----------------------------------------------------------------------------
   3          // Includes
   4          //-----------------------------------------------------------------------------
   5          
   6          #include "compiler_defs.h"
   7          #include "C8051F580_defs.h"            // SFR declarations
   8          
   9          //-----------------------------------------------------------------------------
  10          // Type Definitions
  11          //-----------------------------------------------------------------------------
  12          
  13          //-----------------------------------------------------------------------------
  14          // Function Prototypes
  15          //-----------------------------------------------------------------------------
  16          
  17          void OSCILLATOR_Init (void);
  18          void PORT_Init (void);
  19          void CAN0_Init (void);
  20          void Timer0_Init(void);
  21          void delay_ms(unsigned int ms);
  22          void CAN0_Transmit_Polling(void);
  23          INTERRUPT_PROTO (CAN0_ISR, INTERRUPT_CAN0);
  24          void Receive_Message(void);
  25          //-----------------------------------------------------------------------------
  26          // Global Constants
  27          //-----------------------------------------------------------------------------
  28          
  29          #define SYSCLK       24000000          // System clock speed in Hz
  30          #define MESSAGE_SIZE        8          // Size in bytes of each CAN message
  31                                                 // Range is 1-8
  32          //-----------------------------------------------------------------------------
  33          // Bit Definition Masks
  34          //-----------------------------------------------------------------------------
  35          
  36          // CAN0STAT
  37          #define BOff  0x80                     // Busoff Status
  38          #define EWarn 0x40                     // Warning Status
  39          #define EPass 0x20                     // Error Passive
  40          #define RxOk  0x10                     // Receive Message Successfully
  41          #define TxOk  0x08                     // Transmitted Message Successfully
  42          #define LEC   0x07                     // Last Error Code
  43          
  44          //-----------------------------------------------------------------------------
  45          // Pin Definitions
  46          //-----------------------------------------------------------------------------
  47          
  48          SBIT (LEDY, SFR_P2, 0);                 // LED = 1 turns on the LED
  49          SBIT (LEDG, SFR_P2, 1);                 // LED = 1 turns on the LED
  50          SBIT (LEDR, SFR_P2, 2);
  51          //-----------------------------------------------------------------------------
  52          // Global Variables
  53          //-----------------------------------------------------------------------------
  54          
  55          bit CAN_ERROR = 0;                     // 0 = No Errors occurred
C51 COMPILER V9.54   MAIN                                                                  04/22/2025 16:36:42 PAGE 2   

  56          U8 CAN_RX_COMPLETE = 0;  
  57          U8 buffer[8];  
  58          volatile unsigned long timeout_counter = 0;    
  59          //-----------------------------------------------------------------------------
  60          // MAIN Routine
  61          //-----------------------------------------------------------------------------
  62          
  63          void main (void)
  64          { 
  65   1          U16 iter;                           // Loop counter
  66   1      
  67   1          SFRPAGE = ACTIVE_PAGE;              // Set for PCA0MD
  68   1      
  69   1          PCA0MD &= ~0x40;                    // Disable Watchdog Timer
  70   1      
  71   1          OSCILLATOR_Init ();                 // Initialize oscillator
  72   1          PORT_Init ();                       // Initialize crossbar and GPIO
  73   1          CAN0_Init ();                       // Start CAN peripheral
  74   1              Timer0_Init();
  75   1              LEDG = 0;
  76   1              LEDY = 0;
  77   1              LEDR = 1;
  78   1          EIE2 |= 0x02;                       // Enable CAN interupts
  79   1          EA = 1;                             // Enable global interrupts
  80   1      
  81   1         while (1)
  82   1         {
  83   2                      if (CAN_RX_COMPLETE == 0)
  84   2                      {
  85   3                          LEDG = !LEDG;
  86   3                              delay_ms(1000);
  87   3                      }
  88   2                      else
  89   2                      {
  90   3                              LEDY = 0;
  91   3                              while(1)
  92   3                              {
  93   4                                      CAN0_Transmit_Polling();
  94   4                                      delay_ms(1000);
  95   4                              } 
  96   3                      }
  97   2         }
  98   1      
  99   1      }
*** WARNING C280 IN LINE 65 OF main.c: 'iter': unreferenced local variable
 100          
 101          //-----------------------------------------------------------------------------
 102          // Initialization Subroutines
 103          //-----------------------------------------------------------------------------
 104          
 105          //-----------------------------------------------------------------------------
 106          // OSCILLATOR_Init
 107          //-----------------------------------------------------------------------------
 108          //
 109          // Return Value : None
 110          // Parameters   : None
 111          //
 112          // Initialize the internal oscillator to 24 MHz
 113          //
 114          //-----------------------------------------------------------------------------
 115          void OSCILLATOR_Init (void)
 116          {
C51 COMPILER V9.54   MAIN                                                                  04/22/2025 16:36:42 PAGE 3   

 117   1         U8 SFRPAGE_save = SFRPAGE;
 118   1         SFRPAGE = CONFIG_PAGE;
 119   1      
 120   1         OSCICN = 0x87;                      // Set internal oscillator divider to 1
 121   1      
 122   1         SFRPAGE = SFRPAGE_save;
 123   1      }
 124          
 125          //-----------------------------------------------------------------------------
 126          // PORT_Init
 127          //-----------------------------------------------------------------------------
 128          //
 129          // Return Value : None
 130          // Parameters   : None
 131          //
 132          // This function configures the crossbar and ports pins.
 133          //
 134          // P0.6   digital  push-pull        CAN TX
 135          // P0.7   digital  open-drain       CAN RX
 136          //
 137          // P2.0,1,2   digital  push-pull        LED
 138          //
 139          //-----------------------------------------------------------------------------
 140          
 141          void PORT_Init (void)
 142          {
 143   1         U8 SFRPAGE_save = SFRPAGE;
 144   1         SFRPAGE  = CONFIG_PAGE;             // Port SFR's on Configuration page
 145   1      
 146   1         P0MDOUT  = 0x40;
 147   1         P0SKIP   = 0x3F;
 148   1         P1SKIP   = 0xFF;                   // P0.6 (CAN0 TX) is push-pull
 149   1         P2MDOUT  = 0x07;                   // P2.0 (LED) and LED2.1 is push-pull
 150   1         XBR0     = 0x02;                    // Enable CAN0 on Crossbar
 151   1         XBR2     = 0x40;                    // Enable Crossbar and weak pull-ups
 152   1      
 153   1         SFRPAGE = SFRPAGE_save;
 154   1      }
 155          
 156          //-----------------------------------------------------------------------------
 157          // CAN0_Init
 158          //-----------------------------------------------------------------------------
 159          
 160          
 161          void CAN0_Init (void)
 162          {
 163   1          U8 SFRPAGE_save = SFRPAGE;
 164   1          SFRPAGE  = CAN0_PAGE;               // All CAN register are on page 0x0C
 165   1      
 166   1          CAN0CN |= 0x01;                     // Start Intialization mode
 167   1      
 168   1          //---------Initialize general CAN peripheral settings
 169   1      
 170   1          CAN0CN |= 0x4E;                   
 171   1          //CAN0BT = 0x1402; // 1Mbit/s (BRP = 3; PROP = 4; TSG1 = 1; TSEG2 = 2; SJW = 1)
 172   1              CAN0BT = 0x58C2;                  
 173   1          //---------Initialize settings common to all message objects
 174   1      
 175   1          // Command Mask Register
 176   1          CAN0IF1CM = 0x00F0;                
 177   1              CAN0IF1MC = 0x0080 | MESSAGE_SIZE;
 178   1      
C51 COMPILER V9.54   MAIN                                                                  04/22/2025 16:36:42 PAGE 4   

 179   1          CAN0IF1M1 = 0x0000;
 180   1          CAN0IF1M2 = 0x5FFC;
 181   1                          
 182   1          CAN0IF1A1 = 0x0000;                 
 183   1      //-----------------Message Transmit1-----------------------------------
 184   1              
 185   1              CAN0IF1A2 = 0xA000 | (0x796 << 2);   
 186   1              CAN0IF1CR = 0x05;           
 187   1              while (CAN0IF1CRH & 0x80) {}
 188   1      //-----------------Message Transmit2-----------------------------------
 189   1              CAN0IF1A2 = 0xA000 | (0x541 << 2);   
 190   1              CAN0IF1CR = 0x06;           
 191   1              while (CAN0IF1CRH & 0x80) {}
 192   1      
 193   1      //-----------------Message Recieve-------------------------------------
 194   1          CAN0IF1MC = 0x1480 | MESSAGE_SIZE;  
 195   1          CAN0IF1A2 = 0x8000 | (0x76E << 2);  
 196   1          CAN0IF1CR = 0x10;                  
 197   1          while (CAN0IF1CRH & 0x80) {}       
 198   1      
 199   1      //-----------------Initialize settings for unused message objects
 200   1          CAN0CN &= ~0x41;                   
 201   1          EIE2 |= 0x02;                       
 202   1          SFRPAGE = SFRPAGE_save;
 203   1      }
 204          
 205          
 206          void CAN0_Transmit_Polling(void)
 207          {
 208   1      
 209   1          U8 SFRPAGE_save = SFRPAGE;
 210   1          SFRPAGE = CAN0_PAGE;      
 211   1      
 212   1          CAN0IF1DA1L = buffer[0];  
 213   1          CAN0IF1DA1H = buffer[1];  
 214   1          CAN0IF1DA2L = buffer[2];  
 215   1          CAN0IF1DA2H = buffer[3];  
 216   1          CAN0IF1DB1L = buffer[4];  
 217   1          CAN0IF1DB1H = buffer[5];  
 218   1          CAN0IF1DB2L = buffer[6];  
 219   1          CAN0IF1DB2H = buffer[7];  
 220   1      
 221   1          CAN0IF1CM = 0x0087;                                                     
 222   1          CAN0IF1CR = 0x05;
 223   1              //CAN0IF1CR = 0x06; 
 224   1                       
 225   1          while (CAN0IF1CRH & 0x80) {} 
 226   1          while (!(CAN0STAT & TxOk))   
 227   1          {
 228   2              if (CAN0STAT & (BOff | LEC))  
 229   2              {
 230   3                  CAN_ERROR = 1;        
 231   3                  break;                
 232   3              }
 233   2          }
 234   1          if (!CAN_ERROR)
 235   1          {
 236   2              LEDY = 0;                  
 237   2          }
 238   1          else
 239   1          {
 240   2              LEDY = 1;                  // Turn off LED if error occurred
C51 COMPILER V9.54   MAIN                                                                  04/22/2025 16:36:42 PAGE 5   

 241   2          }
 242   1          SFRPAGE = SFRPAGE_save;
 243   1      }
 244          //-----------------------------------------------------------------------------
 245          // Interrupt Service Routines
 246          //-----------------------------------------------------------------------------
 247          INTERRUPT (CAN0_ISR, INTERRUPT_CAN0)
 248          {
 249   1      
 250   1          U8 status, Interrupt_ID;
 251   1              SFRPAGE = CAN0_PAGE;               
 252   1      
 253   1              status = CAN0STAT;
 254   1              Interrupt_ID = CAN0IID;
 255   1                            
 256   1          CAN0IF1CM = 0x007F;           
 257   1          CAN0IF1CR = Interrupt_ID;                           
 258   1          while (CAN0IF1CRH & 0x80) {}        
 259   1      
 260   1          if (status & RxOk)                  
 261   1          {
 262   2             
 263   2             buffer[0] = CAN0IF1DA1L;    
 264   2                 buffer[1] = CAN0IF1DA1H;    
 265   2             buffer[2] = CAN0IF1DA2L;    
 266   2                 buffer[3] = CAN0IF1DA2H;    
 267   2             buffer[4] = CAN0IF1DB1L;    
 268   2                 buffer[5] = CAN0IF1DB1H;    
 269   2             buffer[6] = CAN0IF1DB2L;    
 270   2                 buffer[7] = CAN0IF1DB2H;    
 271   2      
 272   2                 CAN_RX_COMPLETE = 1;
 273   2      
 274   2          }
 275   1      
 276   1          if (status & LEC)                 
 277   1          {
 278   2      
 279   2             if ((status & LEC) != 0x07) 
 280   2             {
 281   3                CAN_ERROR = 1;
 282   3                        LEDY = 1; 
 283   3             }
 284   2          }
 285   1      
 286   1          if (status & BOff)
 287   1          {
 288   2              CAN_ERROR = 1;
 289   2                      LEDY = 1;
 290   2      
 291   2          }
 292   1      
 293   1          if (status & EWarn)
 294   1          {
 295   2              CAN_ERROR = 1;
 296   2                      LEDY = 1;
 297   2          }
 298   1              SFRPAGE  = ACTIVE_PAGE;
 299   1      }       
 300          
 301          
 302          //--------------------Timer 0 delay------------------------------
C51 COMPILER V9.54   MAIN                                                                  04/22/2025 16:36:42 PAGE 6   

 303          void Timer0_Init(void)
 304          {
 305   1              
 306   1              TMOD &= 0xF0;
 307   1              TMOD |= 0x01; // timer 16bit
 308   1              CKCON |= 0x02;  // SYSCLK/48 = 500 kHz
 309   1              TH0 = (65536 - 500) >> 8;
 310   1              TL0 = (655536 -500) & 0xFF;
 311   1          ET0 = 1;               
 312   1          TR0 = 1;               
 313   1      }
 314          INTERRUPT(Timer0_ISR, INTERRUPT_TIMER0)
 315          {       
 316   1              TH0 = (65536 - 500) >> 8;
 317   1          TL0 = (65536 - 500) & 0xFF;
 318   1          timeout_counter++;
 319   1      }
 320          
 321          void delay_ms(unsigned int ms)
 322          {
 323   1          unsigned long start = timeout_counter;
 324   1          while ((timeout_counter - start) < ms);
 325   1      }
 326          //-----------------------------------------------------------------------------
 327          // End Of File
 328          //-----------------------------------------------------------------------------
 329          


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    521    ----
   CONSTANT SIZE    =   ----    ----
   XDATA SIZE       =   ----    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =     13       6
   IDATA SIZE       =   ----    ----
   BIT SIZE         =      1    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  1 WARNING(S),  0 ERROR(S)
