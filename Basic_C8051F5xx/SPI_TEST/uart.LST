C51 COMPILER V9.54   UART                                                                  04/18/2025 16:51:37 PAGE 1   


C51 COMPILER V9.54, COMPILATION OF MODULE UART
OBJECT MODULE PLACED IN uart.OBJ
COMPILER INVOKED BY: C:\Keil_v5\C51\BIN\C51.exe uart.c DB OE BR INCDIR(c:\SiLabs\MCU_4\Inc)

line level    source

   1          #include <compiler_defs.h>
   2          #include <C8051F580_defs.h> 
   3          #include "uart.h"
*** WARNING C323 IN LINE 16 OF uart.h: newline expected, extra characters found
   4          #include "timer.h"
*** WARNING C323 IN LINE 11 OF timer.h: newline expected, extra characters found
   5          #include "config.h"
*** WARNING C323 IN LINE 12 OF config.h: newline expected, extra characters found
   6          
   7          #define SYSCLK      24000000           
   8          #define BAUDRATE      115200            
   9          
  10          
  11          //U8 UART_Buffer_TX[] = "Hello World\r\n";        
  12          //bit TX_Ready = 1;
  13          
  14          SEGMENT_VARIABLE(UART1_Buffer[UART1_BUFFERSIZE], U8, SEG_XDATA);
  15          
  16          U8 UART1_Buffer_Size = 0;
  17          bit UART1_Received_Full = 0; 
  18          
  19          extern volatile unsigned long timeout_counter;
  20          extern volatile unsigned long last_timeout_counter;
  21          
  22          U16 i;
  23          
  24          
  25          static U8 Byte;
  26          
  27          void UART1_Init (void)
  28          {
  29   1         U8 SFRPAGE_save = SFRPAGE;
  30   1         SFRPAGE = ACTIVE2_PAGE;
  31   1      
  32   1         SCON1 = 0x10;                       // SCON1: 8-bit variable bit rate
  33   1      
  34   1         if (SYSCLK / BAUDRATE / 2 / 256 < 1) 
  35   1         {
  36   2            TH1 = -(SYSCLK / BAUDRATE / 2);
  37   2            CKCON &= ~0x0B;                  // T1M = 1; SCA1:0 = xx
  38   2            CKCON |=  0x08;
  39   2         } 
  40   1         else if (SYSCLK / BAUDRATE / 2 / 256 < 4) 
  41   1         {
  42   2            TH1 = -(SYSCLK / BAUDRATE / 2 / 4);
  43   2            CKCON &= ~0x0B;                  // T1M = 0; SCA1:0 = 01
  44   2            CKCON |=  0x01;
  45   2         } 
  46   1         else if (SYSCLK / BAUDRATE / 2 / 256 < 12) 
  47   1         {
  48   2            TH1 = -(SYSCLK / BAUDRATE / 2 / 12);
  49   2            CKCON &= ~0x0B;                  // T1M = 0; SCA1:0 = 00
  50   2         } 
  51   1         else 
  52   1         {
C51 COMPILER V9.54   UART                                                                  04/18/2025 16:51:37 PAGE 2   

  53   2            TH1 = -(SYSCLK / BAUDRATE / 2 / 48);
  54   2            CKCON &= ~0x0B;                  // T1M = 0; SCA1:0 = 10
  55   2            CKCON |=  0x02;
  56   2         }
  57   1      
  58   1          TL1 = TH1;                          // Init Timer1
  59   1          TMOD &= ~0xF0;                      // TMOD: timer 1 in 8-bit autoreload
  60   1          TMOD |=  0x20;
  61   1          TR1 = 1;                            // START Timer1
  62   1      
  63   1          TI1 = 1;                            // Indicate TX0 ready (SCON1)
  64   1              EIE2 |= 0x08;
  65   1          SFRPAGE = SFRPAGE_save;
  66   1      }
  67          
  68          
  69          
  70          INTERRUPT(UART1_ISR, INTERRUPT_UART1)
  71          { 
  72   1              U8 SFRPAGE_save = SFRPAGE;
  73   1          SFRPAGE = ACTIVE2_PAGE;
  74   1              if (RI1 == 1)
  75   1          {
  76   2                  Byte = SBUF1;                    
  77   2                  if (UART1_Buffer_Size < UART1_BUFFERSIZE)
  78   2                  {
  79   3                     UART1_Buffer[UART1_Buffer_Size] = Byte; // Store in array
  80   3                     UART1_Buffer_Size++;     
  81   3                         last_timeout_counter = timeout_counter;      // Update array's size                   
  82   3                  }
  83   2      
  84   2                      //if((UART1_Buffer_Size >= UART1_BUFFERSIZE)) 
  85   2                      //{
  86   2                              //UART1_Received_Full = 1;
  87   2                      //}
  88   2      
  89   2                      RI1 = 0;  
  90   2                           
  91   2          }
  92   1              SFRPAGE = SFRPAGE_save;
  93   1      }
  94          
  95          U16 CRC16_CCITT_FALSE(U8 *datac, U16 length)
  96          {
  97   1          U16 crc = 0xFFFF; 
  98   1          U16 polynomial = 0x1021;  
  99   1              U16 i;
 100   1              U8  j;
 101   1          for (i = 0; i < length; i++)
 102   1          {
 103   2              crc ^= (datac[i] << 8);
 104   2              for (j = 0; j < 8; j++)
 105   2              {
 106   3                  if (crc & 0x8000)
 107   3                      crc = (crc << 1) ^ polynomial;
 108   3                  else
 109   3                      crc <<= 1;
 110   3              }
 111   2          }
 112   1          return crc;
 113   1      }
 114          
C51 COMPILER V9.54   UART                                                                  04/18/2025 16:51:37 PAGE 3   

 115          void SEND_String(U8 *str, U8 lenght)
 116          {
 117   1              U8 SFRPAGE_save = SFRPAGE;
 118   1              
 119   1          SFRPAGE = ACTIVE2_PAGE;
 120   1              
 121   1          //while(*str != '\0')       
 122   1              for(i = 0; i <lenght; i++)           
 123   1          {
 124   2              while (!TI1);                
 125   2              TI1 = 0;                     
 126   2              SBUF1 = *str++;
 127   2                      LEDG = !LEDG;              
 128   2          }
 129   1      
 130   1          SFRPAGE = SFRPAGE_save;
 131   1      }
*** WARNING C294 IN LINE 42 OF uart.c: unreachable code


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    301    ----
   CONSTANT SIZE    =   ----    ----
   XDATA SIZE       =    253    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =      4      12
   IDATA SIZE       =   ----    ----
   BIT SIZE         =      1    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  4 WARNING(S),  0 ERROR(S)
